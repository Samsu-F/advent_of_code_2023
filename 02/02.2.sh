#!/bin/sh

sed -E 's/^Game ([0-9]+): *(.*)$/\2 #N\1R0,G0,B0,/g' ./input > ./tmp

while grep -Eqs '^[^#]' ./tmp; do
    sed -E 's/^([0-9]+) red[,; ]*([^#]*)(#N[0-9]+)(R[0-9,]*)(G[0-9,]*)(B[0-9,]*)/\2\3\4\1,\5\6/g' ./tmp | \
        sed -E 's/^([0-9]+) green[,; ]*([^#]*)(#N[0-9]+)(R[0-9,]*)(G[0-9,]*)(B[0-9,]*)/\2\3\4\5\1,\6/g' | \
        sed -E 's/^([0-9]+) blue[,; ]*([^#]*)(#N[0-9]+)(R[0-9,]*)(G[0-9,]*)(B[0-9,]*)/\2\3\4\5\6\1,/g' | \
        sed -E 's/,0+([1-9][0-9]*),/,\1,/g' > ./tmp_new
    mv ./tmp_new ./tmp
done

while grep -Eqs '[0-9]+,[0-9]+' ./tmp; do
    sed -E 's/([RGB])([0-9]+),([0-9]+),/\1@\2,@\3,/g' ./tmp | \
        sed -E 's/@([0-9])/\1@/g' | \
        sed -E 's/[0-9]+@,([0-9]+)@([0-9]+),/\1\2,/g' | \
        sed -E 's/([0-9]+)@([0-9]+),[0-9]+@,/\1\2,/g' | \
        sed -E 's/([0-9]+)@,([0-9]+)@,/X\1,X\2,/g' | \
        sed -E 's/X(9[0-9]*),[0-9]*X[0-8][0-9]*,/\1,/g' | \
        sed -E 's/X(8[0-9]*),[0-9]*X[0-7][0-9]*,/\1,/g' | \
        sed -E 's/X(7[0-9]*),[0-9]*X[0-6][0-9]*,/\1,/g' | \
        sed -E 's/X(6[0-9]*),[0-9]*X[0-5][0-9]*,/\1,/g' | \
        sed -E 's/X(5[0-9]*),[0-9]*X[0-4][0-9]*,/\1,/g' | \
        sed -E 's/X(4[0-9]*),[0-9]*X[0-3][0-9]*,/\1,/g' | \
        sed -E 's/X(3[0-9]*),[0-9]*X[0-2][0-9]*,/\1,/g' | \
        sed -E 's/X(2[0-9]*),[0-9]*X[0-1][0-9]*,/\1,/g' | \
        sed -E 's/X(1[0-9]*),[0-9]*X[0-0][0-9]*,/\1,/g' | \
        sed -E 's/X[0-8][0-9]*,[0-9]*X(9[0-9]*),/\1,/g' | \
        sed -E 's/X[0-7][0-9]*,[0-9]*X(8[0-9]*),/\1,/g' | \
        sed -E 's/X[0-6][0-9]*,[0-9]*X(7[0-9]*),/\1,/g' | \
        sed -E 's/X[0-5][0-9]*,[0-9]*X(6[0-9]*),/\1,/g' | \
        sed -E 's/X[0-4][0-9]*,[0-9]*X(5[0-9]*),/\1,/g' | \
        sed -E 's/X[0-3][0-9]*,[0-9]*X(4[0-9]*),/\1,/g' | \
        sed -E 's/X[0-2][0-9]*,[0-9]*X(3[0-9]*),/\1,/g' | \
        sed -E 's/X[0-1][0-9]*,[0-9]*X(2[0-9]*),/\1,/g' | \
        sed -E 's/X[0-0][0-9]*,[0-9]*X(1[0-9]*),/\1,/g' | \
        sed -E 's/X([0-9])/\1X/g' | \
        sed -E 's/([0-9]+)X,\1X,/\1,/g' > ./tmp_new
    mv ./tmp_new ./tmp
done

sed -E 's/#N[0-9]+R/(/g' ./tmp | \
    sed -E 's/,[GB]/\*/g' | \
    sed -E 's/,$/)/g' | \
    paste -sd+ | \
    ../mul_sum_regex.sh

rm ./tmp

